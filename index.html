<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Newspaper â€” Living Globe Prototype</title>

<!-- Minimal fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,600&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#05070a;
    --panel:#0f1316;
    --accent:#26e1c2;
    --muted:#9aa6a3;
    --paper:#fbf7f2;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(180deg,var(--bg),#071018 60%); color:var(--paper); overflow:hidden}
  #app{position:fixed;inset:0;display:flex;align-items:stretch;justify-content:stretch}
  /* Left: 3D globe */
  #globePane{flex:1;position:relative;overflow:hidden}
  canvas{width:100%;height:100%;display:block}
  .uiTop{position:absolute;left:18px;top:18px;z-index:30;display:flex;gap:12px;align-items:center}
  .logo{font-family:'Playfair Display',serif;font-weight:700;font-size:20px;color:var(--paper);letter-spacing:0.02em}
  .control{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .control.small{padding:6px 10px;font-size:14px}
  .nowReading{position:absolute;right:18px;top:18px;z-index:30;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));padding:10px 14px;border-radius:10px;font-size:14px;color:var(--paper);display:flex;gap:10px;align-items:center;cursor:pointer}
  .nowReading .caption{color:var(--paper);font-weight:600}
  .nowReading .hint{color:var(--muted);font-size:13px}

  /* floating html cards projected from the globe */
  .floatingCard{
    position:absolute;transform-origin:center center;pointer-events:auto;z-index:20;
    width:200px;border-radius:12px;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);backdrop-filter: blur(6px);
    transition: transform .26s cubic-bezier(.2,.9,.3,1), opacity .22s;
    display:flex;gap:8px;align-items:flex-start;
  }
  .floatingCard .thumb{width:72px;height:56px;border-radius:8px;overflow:hidden;flex:0 0 auto;border:1px solid rgba(255,255,255,0.03)}
  .floatingCard .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .floatingCard .meta{flex:1;display:flex;flex-direction:column}
  .floatingCard h4{margin:0;font-size:15px;line-height:1.05;font-weight:700;color:var(--paper);font-family:'Playfair Display',serif}
  .floatingCard p{margin:6px 0 0;font-size:13px;color:var(--muted);line-height:1.25}

  /* newspaper overlay (page view) */
  #pageView{position:absolute;inset:0;z-index:60;display:none;align-items:center;justify-content:center;padding:36px;pointer-events:none}
  #pageCard{width:min(1100px,94%);height:86%;background:linear-gradient(180deg,#0f1415, rgba(255,255,255,0.01));border-radius:18px;border:1px solid rgba(255,255,255,0.04);overflow:auto;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,0.6);pointer-events:auto}
  .pageHeader{display:flex;align-items:center;gap:12px}
  .pageHeader h2{margin:0;font-family:'Playfair Display',serif;font-size:26px}
  .pageGrid{display:grid;grid-template-columns:repeat(12,1fr);grid-auto-rows:180px;gap:14px;margin-top:14px}
  .cardLarge{grid-column:span 8;grid-row:span 2;background:#0b0f11;border-radius:12px;padding:12px;overflow:hidden;position:relative}
  .cardSub{grid-column:span 4;grid-row:span 1;background:#0b0f11;border-radius:12px;padding:10px;overflow:hidden}
  .cardNormal{background:#081013;border-radius:10px;padding:8px;overflow:hidden}
  .cardLarge img,.cardSub img,.cardNormal img{width:100%;height:100%;object-fit:cover;border-radius:8px}
  .metaTiny{color:var(--muted);font-size:13px;margin-top:8px}

  /* small bottom toolbar */
  .toolbar{position:absolute;left:50%;transform:translateX(-50%);bottom:18px;z-index:40;display:flex;gap:10px}
  .btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:10px 14px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--paper);font-weight:600}

  /* overlay close */
  .closeBtn{position:absolute;right:18px;top:18px;background:rgba(255,255,255,0.03);padding:8px;border-radius:10px;cursor:pointer;z-index:70}

  /* organic accents */
  .filament{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none;mix-blend-mode:screen;opacity:0.9}
  .muted{color:var(--muted)}
  @media (max-width:900px){
    .floatingCard{width:170px}
    .cardLarge{grid-column:span 12;grid-row:span 2}
    .cardSub{grid-column:span 6}
  }
</style>
</head>

<body>
<div id="app">
  <div id="globePane">
    <div class="uiTop">
      <div class="logo">Newspaper</div>
      <div class="control small" id="centerBtn" title="Center Globe">â¤¾</div>
      <div class="control small" id="enterBtn" title="Zoom to country in front">Zoom In</div>
    </div>

    <div class="nowReading" id="nowReading" style="display:none" title="Click to open current story">
      <div class="caption" id="nowReadingTitle">Now reading</div>
      <div class="hint muted">tap to open</div>
    </div>

    <div id="threeContainer"></div>

    <div class="toolbar">
      <div class="btn" id="listenBtn">ðŸŽ§ Listen to News</div>
      <div class="btn" id="voicePickerBtn">Voice: Friend</div>
      <div class="btn" id="musicToggle">Music: On</div>
    </div>

    <!-- newspaper overlay -->
    <div id="pageView">
      <div id="pageCard" role="dialog" aria-modal="true">
        <div class="closeBtn" id="closePage">âœ•</div>
        <div class="pageHeader">
          <h2 id="pageTitle">Country â€” Page</h2>
          <div class="muted" id="pageSub">Latest stories</div>
        </div>
        <div id="pageGridWrap">
          <div class="pageGrid" id="pageGrid"></div>
        </div>
      </div>
    </div>

    <div class="filament" aria-hidden="true">
      <!-- subtle moving filaments are drawn in canvas via WebGL; left as placeholder for style -->
    </div>

  </div>
</div>

<!-- audio element for background music (placeholder) -->
<audio id="bgMusic" loop crossorigin="anonymous"></audio>

<!-- import three.js as module -->
<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
  import { OrbitControls } from 'https://unpkg.com/three@0.152.2/examples/jsm/controls/OrbitControls.js';
  import { GLTFLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

  // ---------- scene setup ----------
  const container = document.getElementById('threeContainer');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 0, 3.5);

  const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); 
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  container.appendChild(renderer.domElement);

  // lights
  scene.add(new THREE.AmbientLight(0xffffff, 0.95));
  const dir = new THREE.DirectionalLight(0xffffff, 0.35);
  dir.position.set(5, 3, 5);
  scene.add(dir);

  // globe
  const loader = new THREE.TextureLoader();
  const earthTex = loader.load('https://cdn.jsdelivr.net/gh/planetarymaps/planetary-textures@main/earth/earth-day.jpg');
  const earthBump = loader.load('https://threejs.org/examples/textures/earthbump1k.jpg');

  const globeGeo = new THREE.SphereGeometry(1.25, 64, 64);
  const globeMat = new THREE.MeshStandardMaterial({ map: earthTex, bumpMap: earthBump, bumpScale: 0.01, roughness:1, metalness:0 });
  const globe = new THREE.Mesh(globeGeo, globeMat);
  scene.add(globe);

  // subtle atmosphere
  const atmGeo = new THREE.SphereGeometry(1.27, 64, 64);
  const atmMat = new THREE.MeshBasicMaterial({ color:0x88aaff, transparent:true, opacity:0.05, side:THREE.BackSide });
  const atmosphere = new THREE.Mesh(atmGeo, atmMat);
  scene.add(atmosphere);

  // markers group (invisible geometry used for raycast)
  const markerGroup = new THREE.Group();
  scene.add(markerGroup);

  // controls
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enablePan = false;
  controls.minDistance = 1.6;
  controls.maxDistance = 8;
  controls.rotateSpeed = 0.6;
  controls.zoomSpeed = 1.0;

  // responsive
  window.addEventListener('resize', () => {
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
  });

  // small auto-rotation
  let autoRotate = true;
  const rotateStrength = 0.0005;

  // ---------- sample posts (replace or expand) ----------
  // Each post: id, country, title, text, lat, lon, img
  const posts = [
    {id:1, country:'Nigeria', title:'Market laughter', text:'A goat crashed a wedding in Lekki and turned it into a celebration.', lat:6.5244, lon:3.3792, img:'https://images.unsplash.com/photo-1542251151-9a19d5c6b0f9?q=80&w=1200&auto=format&fit=crop'},
    {id:2, country:'Japan', title:'Rain dancers', text:'School kids danced under the sudden rain in Kyoto.', lat:35.0116, lon:135.7681, img:'https://images.unsplash.com/photo-1526481280698-3ac0f3b8f0cc?q=80&w=1200&auto=format&fit=crop'},
    {id:3, country:'Brazil', title:'Sunset drums', text:'Drums and laughter at the beach as the sun went down in Salvador.', lat:-12.9711, lon:-38.5108, img:'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=1200&auto=format&fit=crop'},
    {id:4, country:'USA', title:'Food truck moment', text:'A pop-up market brought neighbors together downtown.', lat:40.7128, lon:-74.0060, img:'https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=1200&auto=format&fit=crop'},
    {id:5, country:'India', title:'Monsoon streets', text:'Children made paper boats in the new puddles.', lat:28.6139, lon:77.2090, img:'https://images.unsplash.com/photo-1508921912186-1d1a45ebb3c1?q=80&w=1200&auto=format&fit=crop'},
    {id:6, country:'Egypt', title:'Market spices', text:'A perfumed breeze from the bazaar turned heads.', lat:30.0444, lon:31.2357, img:'https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1200&auto=format&fit=crop'},
    {id:7, country:'Australia', title:'Coastal choir', text:'A choir sang as fishermen mended nets at dawn.', lat:-33.8688, lon:151.2093, img:'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1200&auto=format&fit=crop'}
  ];

  // map posts to marker meshes
  const markerGeometry = new THREE.SphereGeometry(0.02, 8, 8);
  const markerMaterial = new THREE.MeshBasicMaterial({color:0xff6b6b});

  function latLonToVector3(lat, lon, radius=1.25){
    const phi = (90 - lat) * (Math.PI/180);
    const theta = (lon + 180) * (Math.PI/180);
    const x = - (radius) * Math.sin(phi) * Math.cos(theta);
    const z = (radius) * Math.sin(phi) * Math.sin(theta);
    const y = (radius) * Math.cos(phi);
    return new THREE.Vector3(x,y,z);
  }

  posts.forEach(p=>{
    const m = new THREE.Mesh(markerGeometry, markerMaterial.clone());
    m.position.copy(latLonToVector3(p.lat, p.lon, 1.27));
    m.userData = { postId: p.id };
    markerGroup.add(m);
  });

  // ---------- HTML floating cards (project post info onto screen) ----------
  const floatingMap = new Map(); // postId -> element
  function createFloatingCard(post){
    const el = document.createElement('div');
    el.className = 'floatingCard';
    el.id = 'post'+post.id;
    el.innerHTML = `
      <div class="thumb"><img src="${post.img}" alt="${post.title}"></div>
      <div class="meta"><h4>${post.title}</h4><p>${post.text.slice(0,90)}${post.text.length>90?'â€¦':''}</p></div>
    `;
    el.addEventListener('click', ()=> openPostPage(post.country));
    document.body.appendChild(el);
    floatingMap.set(post.id, el);
  }
  posts.forEach(p=>createFloatingCard(p));

  // project 3D position to 2D screen
  function updateFloatingPositions(){
    posts.forEach(p=>{
      const el = floatingMap.get(p.id);
      const pos = latLonToVector3(p.lat, p.lon, 1.27).clone();
      // world to screen
      const projected = pos.project(camera);
      const x = (projected.x * 0.5 + 0.5) * window.innerWidth;
      const y = (-projected.y * 0.5 + 0.5) * window.innerHeight;
      // check if in front
      const inFront = projected.z < 1;
      if(inFront && projected.x>-1.2 && projected.x<1.2 && projected.y>-1.2 && projected.y<1.2){
        el.style.display = 'flex';
        el.style.transform = `translate(-50%,-50%) translate(${x}px, ${y}px) scale(${1 + Math.max(0, 0.12 - projected.z*0.06)})`;
        el.style.opacity = 1 - Math.max(0, projected.z*0.25);
      } else {
        el.style.opacity = 0;
        el.style.display = 'none';
      }
    });
  }

  // ---------- interactions: click/dblclick/zoom ----------
  const raycaster = new THREE.Raycaster();
  const pointer = new THREE.Vector2();

  function onPointerDown(e){
    // ensure pointer coords for raycast
    const rect = renderer.domElement.getBoundingClientRect();
    pointer.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    pointer.y = - ((e.clientY - rect.top) / rect.height) * 2 + 1;
    raycaster.setFromCamera(pointer, camera);
    const intersects = raycaster.intersectObjects(markerGroup.children.concat(globe));
    if(intersects.length>0){
      const hit = intersects[0].object;
      if(hit.userData && hit.userData.postId){
        const post = posts.find(x=>x.id===hit.userData.postId);
        openPostPage(post.country);
      } else {
        // clicked globe surface
        // optional: can create new post at that lat/lon
      }
    }
  }

  renderer.domElement.addEventListener('pointerdown', onPointerDown);

  // double click (or double tap) -> zoom into current front country
  renderer.domElement.addEventListener('dblclick', (ev)=>{
    zoomToFrontCountry();
  });

  // center button
  document.getElementById('centerBtn').addEventListener('click', ()=>{
    // reset camera and controls
    controls.reset();
    camera.position.set(0,0,3.5);
  });

  // enter/zoom button (zoom to front-most post/country)
  document.getElementById('enterBtn').addEventListener('click', ()=> zoomToFrontCountry());

  // find the country currently at the center of screen (camera direction)
  function zoomToFrontCountry(){
    // determine which post's surface normal is nearest camera look direction
    const cameraDir = new THREE.Vector3();
    camera.getWorldDirection(cameraDir);
    let best = null;
    let bestDot = -Infinity;
    posts.forEach(p=>{
      const pos = latLonToVector3(p.lat, p.lon, 1.27).clone().normalize();
      const dot = pos.dot(cameraDir);
      if(dot > bestDot){ bestDot = dot; best = p; }
    });
    if(best){
      // animate camera to face that lat/lon point (we will move controls.target and camera position)
      const targetVec = latLonToVector3(best.lat, best.lon, 1.25);
      animateCameraToTarget(targetVec, ()=> openPostPage(best.country));
    }
  }

  // simple camera animation to target position
  function animateCameraToTarget(targetVec, onComplete){
    autoRotate = false;
    const startPos = camera.position.clone();
    const startTarget = controls.target.clone();
    const endTarget = targetVec.clone().multiplyScalar(0.9); // slightly above surface
    const endPos = endTarget.clone().normalize().multiplyScalar(1.9); // zoom distance
    const frames = 45; let t=0;
    const id = setInterval(()=>{
      t++;
      const k = t/frames;
      camera.position.lerpVectors(startPos, endPos, easeInOut(k));
      controls.target.lerpVectors(startTarget, endTarget, easeInOut(k));
      controls.update();
      if(t>=frames){ clearInterval(id); if(onComplete) onComplete(); }
    }, 16);
  }
  function easeInOut(t){ return t<.5 ? 2*t*t : -1 + (4 - 2*t)*t; }

  // ---------- page view: compute feature story and render grid ----------
  const pageView = document.getElementById('pageView');
  const pageGrid = document.getElementById('pageGrid');
  const pageTitle = document.getElementById('pageTitle');
  const pageSub = document.getElementById('pageSub');
  document.getElementById('closePage').addEventListener('click', closePageView);

  function openPostPage(country){
    // filter posts by country
    const list = posts.filter(p=>p.country===country);
    if(list.length===0) return; // nothing
    // compute cinematic score (simple heuristic)
    list.forEach(p=>{
      const textScore = Math.min(1, p.text.length / 140);
      const emotive = (/!|wonder|amazed|amazing|wild|love|surpris/i.test(p.text)) ? 0.18 : 0;
      const randomBoost = Math.random()*0.12;
      p._score = 0.55 * textScore + 0.35 * (p.img?0.9:0.5) + emotive + randomBoost;
    });
    // sort desc
    list.sort((a,b)=>b._score - a._score);
    // pick feature = top
    const feature = list[0];
    const subFeature = (list.length>1 && list[1]._score >= feature._score * 0.85) ? list[1] : null;
    // prepare grid
    pageTitle.textContent = country + ' â€” Page';
    pageSub.textContent = `Stories found: ${list.length}`;
    pageGrid.innerHTML = '';

    // populate: large feature
    const large = document.createElement('div'); large.className='cardLarge';
    large.innerHTML = `<div style="height:100%;display:flex;flex-direction:column"><div style="flex:1;overflow:hidden;border-radius:8px"><img src="${feature.img}" alt="${feature.title}"></div>
      <div style="margin-top:8px"><h3 style="margin:6px 0;font-family:'Playfair Display',serif">${feature.title}</h3><div class="metaTiny">${feature.text}</div></div></div>`;
    pageGrid.appendChild(large);

    // sub feature slot
    if(subFeature){
      const sub = document.createElement('div'); sub.className='cardSub';
      sub.innerHTML = `<div style="height:100%;overflow:hidden;border-radius:8px"><img src="${subFeature.img}" alt="${subFeature.title}"></div>
        <div style="margin-top:8px"><h4 style="margin:6px 0">${subFeature.title}</h4><div class="metaTiny">${subFeature.text}</div></div>`;
      pageGrid.appendChild(sub);
    } else {
      // empty grid cell for layout balance
      const spacer = document.createElement('div'); spacer.className='cardSub';
      spacer.innerHTML = `<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">No sub-feature</div>`;
      pageGrid.appendChild(spacer);
    }

    // remaining normal stories (fill grid with a few)
    const remaining = list.slice(subFeature?2:1);
    const fillSlots = 9; // adjust
    for(let i=0;i<fillSlots;i++){
      const p = remaining[i];
      const cell = document.createElement('div'); cell.className='cardNormal';
      if(p){
        cell.innerHTML = `<div style="height:100%;overflow:hidden;border-radius:8px"><img src="${p.img}" alt="${p.title}"></div><div style="margin-top:6px;font-weight:600">${p.title}</div>
          <div class="metaTiny">${p.text.slice(0,120)}</div>`;
      } else {
        cell.innerHTML = `<div style="height:100%;display:flex;align-items:center;justify-content:center;color:var(--muted)">â€”</div>`;
      }
      pageGrid.appendChild(cell);
    }

    pageView.style.display = 'flex';
    pageView.animate([{opacity:0},{opacity:1}], {duration:360, fill:'forwards'});
  }

  function closePageView(){
    pageView.animate([{opacity:1},{opacity:0}], {duration:240, fill:'forwards'}).onfinish = ()=>{
      pageView.style.display = 'none';
    };
  }

  // ---------- LISTEN TO NEWS (speech synthesis) ----------
  const listenBtn = document.getElementById('listenBtn');
  const nowReading = document.getElementById('nowReading');
  const nowReadingTitle = document.getElementById('nowReadingTitle');

  let listening = false;
  let currentQueue = [];
  let playIndex = 0;
  let utter = null;
  let voiceStyle = 'friend'; // simple label for demonstration

  listenBtn.addEven
